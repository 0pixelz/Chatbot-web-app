<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #111827; color: white; }
.calendar-wrapper { overflow: hidden; position: relative; }
.calendar-container { display: flex; transition: transform 0.3s ease; will-change: transform; }
.calendar-grid { min-width: 100%; display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 10px 0; }
.calendar-cell { background-color: #374151; min-height: 80px; border-radius: 8px; padding: 6px; position: relative; cursor: pointer; }
.calendar-cell.today { background-color: #4b5563; border: 2px solid #60a5fa; }
.event-badge { background: #60a5fa; color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 6px; display: block; margin-top: 4px; text-align: center; cursor: pointer; }
.weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: #9CA3AF; }
</style>
</head>
<body class="p-4">

<h1 class="text-2xl font-bold mb-4">My Calendar</h1>

<div class="flex justify-center items-center mb-2 space-x-4">
  <button onclick="changeMonth(-1)" class="px-3 py-1 bg-gray-700 rounded">&lt;</button>
  <h2 id="monthTitle" class="text-lg font-semibold"></h2>
  <button onclick="changeMonth(1)" class="px-3 py-1 bg-gray-700 rounded">&gt;</button>
</div>

<div class="weekdays mb-1">
  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
</div>

<div class="calendar-wrapper mb-4">
  <div id="calendarContainer" class="calendar-container"></div>
</div>

<hr class="my-4 border-gray-700">

<h2 class="text-xl mb-2">Your Events:</h2>
<div id="eventList" class="space-y-2"></div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 p-6 rounded-lg w-80">
    <h3 class="text-lg font-bold mb-4">Event</h3>
    <input type="hidden" id="modalDate">
    <input type="text" id="eventName" placeholder="Title" class="w-full mb-2 p-2 rounded bg-gray-700 text-white">
    <textarea id="eventDescription" placeholder="Description" class="w-full mb-2 p-2 rounded bg-gray-700 text-white"></textarea>
    <label class="flex items-center mb-2"><input type="checkbox" id="allDay" class="mr-2"> All Day</label>
    <input type="time" id="eventTime" class="w-full mb-2 p-2 rounded bg-gray-700 text-white">
    <select id="repeat" class="w-full mb-4 p-2 rounded bg-gray-700 text-white">
      <option value="none">No Repeat</option>
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div class="flex space-x-2">
      <button onclick="saveModal()" class="flex-1 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Save</button>
      <button onclick="deleteModal()" id="deleteButton" class="flex-1 hidden bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Delete</button>
      <button onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
    </div>
  </div>
</div>

<!-- Delete Confirm -->
<div id="deleteConfirm" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 p-6 rounded-lg w-80 text-center">
    <h3 class="text-lg font-bold mb-4">Delete Event</h3>
    <p class="mb-4">Delete only this or all in series?</p>
    <div class="flex space-x-2 justify-center">
      <button onclick="confirmDelete('single')" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Only This</button>
      <button onclick="confirmDelete('all')" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded">All</button>
    </div>
    <button onclick="closeDeleteModal()" class="block mt-4 text-gray-400 hover:underline">Cancel</button>
  </div>
</div>

<script>
let events = {{ events|tojson }};
let currentDate = new Date();
let currentYear = currentDate.getFullYear();
let currentMonth = currentDate.getMonth();
let isDragging = false, startX = 0, currentX = 0, offsetX = 0;
let deleteTargetId = null, deleteTargetParent = null;

const container = document.getElementById('calendarContainer');

function render() {
  container.innerHTML = '';
  for (let offset = -1; offset <= 1; offset++) {
    const date = new Date(currentYear, currentMonth + offset);
    const grid = document.createElement('div');
    grid.className = 'calendar-grid';
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
    const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const today = new Date().toDateString() === new Date(date.getFullYear(), date.getMonth(), d).toDateString();
      const cell = document.createElement('div');
      cell.className = `calendar-cell ${today ? 'today' : ''}`;
      cell.innerHTML = `<div>${d}</div>${renderEvents(dateStr)}`;
      cell.onclick = () => openModal(dateStr);
      grid.appendChild(cell);
    }
    container.appendChild(grid);
  }
  container.style.transform = `translateX(-100%)`;
  document.getElementById('monthTitle').innerText = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
  renderEventList();
}

function renderEvents(dateStr) {
  return Object.entries(events).filter(([id, e]) => e.date === dateStr).map(([id, e]) => `<span class="event-badge" onclick="event.stopPropagation(); openModal('${dateStr}','${id}','${e.title}','${e.time}',${e.allDay},'${e.repeat}','${e.parentId}','${e.description}')">${e.title}</span>`).join('');
}

function renderEventList() {
  const list = document.getElementById('eventList');
  const monthStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
  const html = Object.entries(events).filter(([id, e]) => e.date.startsWith(monthStr))
    .map(([id, e]) => `<div class="p-2 bg-gray-800 rounded cursor-pointer" onclick="openModal('${e.date}','${id}','${e.title}','${e.time}',${e.allDay},'${e.repeat}','${e.parentId}','${e.description}')"><strong>${e.title}</strong><br>${e.date} ${e.allDay ? "(All Day)" : e.time}<br><span class="text-xs">${e.description}</span></div>`).join('');
  list.innerHTML = html || `<p class="text-gray-400">No events this month.</p>`;
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  render();
}

container.addEventListener('touchstart', e => { isDragging = true; startX = e.touches[0].clientX; });
container.addEventListener('touchmove', e => { if (!isDragging) return; currentX = e.touches[0].clientX; offsetX = currentX - startX; container.style.transition = "none"; container.style.transform = `translateX(${offsetX - container.clientWidth}px)`; });
container.addEventListener('touchend', () => {
  container.style.transition = "transform 0.3s ease";
  if (offsetX < -50) changeMonth(1);
  else if (offsetX > 50) changeMonth(-1);
  else container.style.transform = `translateX(-100%)`;
  isDragging = false; offsetX = 0;
});

function openModal(dateStr, eventId = null, title = '', time = '', allDay = false, repeat = 'none', parentId = '', description = '') {
  const m = document.getElementById('modal'); m.dataset.eventId = eventId || ''; m.dataset.parentId = parentId || '';
  document.getElementById('modalDate').value = dateStr; document.getElementById('eventName').value = title;
  document.getElementById('eventTime').value = time; document.getElementById('eventDescription').value = description;
  document.getElementById('allDay').checked = allDay; document.getElementById('repeat').value = repeat;
  document.getElementById('deleteButton').classList.toggle('hidden', !eventId);
  m.style.display = 'flex';
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

function saveModal() {
  const id = document.getElementById('modal').dataset.eventId || crypto.randomUUID();
  const data = {
    title: document.getElementById('eventName').value,
    date: document.getElementById('modalDate').value,
    description: document.getElementById('eventDescription').value,
    time: document.getElementById('eventTime').value,
    allDay: document.getElementById('allDay').checked,
    repeat: document.getElementById('repeat').value,
    parentId: document.getElementById('modal').dataset.parentId || crypto.randomUUID()
  };
  fetch(`/save_event/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(() => location.reload());
}

function deleteModal() {
  deleteTargetId = document.getElementById('modal').dataset.eventId;
  deleteTargetParent = document.getElementById('modal').dataset.parentId;
  document.getElementById('deleteConfirm').style.display = 'flex';
}

function closeDeleteModal() { document.getElementById('deleteConfirm').style.display = 'none'; }

function confirmDelete(mode) {
  if (mode === 'all') {
    for (const [id, e] of Object.entries(events)) if (e.parentId === deleteTargetParent) fetch(`/delete_event/${id}`, { method: 'POST' });
  } else fetch(`/delete_event/${deleteTargetId}`, { method: 'POST' });
  location.reload();
}

render();
</script>
</body>
</html>

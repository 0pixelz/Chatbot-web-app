<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .calendar-wrapper {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .calendar-slide {
      flex: 0 0 100%;
      scroll-snap-align: start;
    }
  </style>
</head>
<body class="{% if settings.theme == 'dark' %}bg-gray-900 text-white{% else %}bg-white text-black{% endif %} min-h-screen p-4">

<h1 class="text-2xl font-bold mb-4">Calendar</h1>

<div class="flex justify-between items-center mb-4">
  <button onclick="prevMonth()" class="px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-400">Previous</button>
  <h2 id="monthYear" class="text-xl font-semibold"></h2>
  <button onclick="nextMonth()" class="px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-400">Next</button>
</div>

<div id="calendar" class="calendar-wrapper mb-6"></div>

<h2 class="text-xl font-semibold mb-4">Add Event</h2>
<div class="space-y-2 mb-6">
  <input type="text" id="eventTitle" placeholder="Title" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %}">
  <input type="text" id="eventDescription" placeholder="Description" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %}">
  <input type="time" id="eventTime" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %}">
  <select id="eventRepeat" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %}">
    <option value="none">No Repeat</option>
    <option value="daily">Daily</option>
    <option value="weekly">Weekly</option>
    <option value="monthly">Monthly</option>
  </select>
  <button onclick="addEvent()" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-500">Add Event</button>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="p-6 rounded-lg w-80 {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %}">
    <h3 class="text-lg font-bold mb-4">Delete Event</h3>
    <p>Delete this event or all repeating events?</p>
    <div class="flex space-x-2 mt-4">
      <button onclick="confirmDelete('single')" class="flex-1 bg-red-500 text-white rounded p-2">Only This</button>
      <button onclick="confirmDelete('all')" class="flex-1 bg-yellow-500 text-white rounded p-2">All Events</button>
    </div>
    <button onclick="closeDeleteModal()" class="block mt-4 text-sm text-gray-400 hover:underline">Cancel</button>
  </div>
</div>

<script>
const events = {{ events|tojson }};
const uid = "{{ uid }}";
let currentDate = new Date();
let activeDate = null;
let activeId = null;

function renderCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';

  for (let i = -1; i <= 1; i++) {
    const viewDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
    const slide = document.createElement('div');
    slide.className = 'calendar-slide p-2';

    const title = document.createElement('h3');
    title.className = "text-lg font-semibold mb-2";
    title.textContent = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    slide.appendChild(title);

    const grid = document.createElement('div');
    grid.className = "grid grid-cols-7 gap-2";

    const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
    const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();

    for (let d = 0; d < startDay; d++) {
      grid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const cell = document.createElement('div');
      cell.className = "{% if settings.theme == 'dark' %}bg-gray-700 text-white{% else %}bg-gray-200 text-black{% endif %} p-2 rounded cursor-pointer";
      cell.textContent = day;
      cell.onclick = () => openEvent(dateStr);
      
      const dayEvents = Object.values(events).filter(e => e.date === dateStr);
      dayEvents.forEach(e => {
        const badge = document.createElement('div');
        badge.className = "mt-1 text-xs bg-blue-500 text-white rounded p-1";
        badge.textContent = e.title;
        badge.onclick = (ev) => {
          ev.stopPropagation();
          openEvent(dateStr, e.id);
        };
        cell.appendChild(badge);
      });

      grid.appendChild(cell);
    }

    slide.appendChild(grid);
    calendar.appendChild(slide);
  }

  document.getElementById('monthYear').textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
}

function prevMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
}

function openEvent(date, id = null) {
  activeDate = date;
  activeId = id;

  const title = id ? events[id].title : '';
  const description = id ? events[id].description : '';
  const time = id ? events[id].time : '';
  const repeat = id ? events[id].repeat : 'none';

  document.getElementById('eventTitle').value = title;
  document.getElementById('eventDescription').value = description;
  document.getElementById('eventTime').value = time;
  document.getElementById('eventRepeat').value = repeat;

  document.getElementById('deleteModal').classList.toggle('hidden', !id);
}

function addEvent() {
  const title = document.getElementById('eventTitle').value;
  const description = document.getElementById('eventDescription').value;
  const time = document.getElementById('eventTime').value;
  const repeat = document.getElementById('eventRepeat').value;

  if (!title) return alert("Title is required");

  const id = activeId || crypto.randomUUID();
  const parentId = activeId ? events[activeId].parentId : crypto.randomUUID();

  const newEvent = { title, description, date: activeDate, time, repeat, parentId, id };
  events[id] = newEvent;

  fetch(`/save_event/${id}`, {
    method: "POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(newEvent)
  });

  renderCalendar();
}

function confirmDelete(type) {
  if (type === 'single') {
    fetch(`/delete_event/${activeId}`, { method: "POST" });
    delete events[activeId];
  } else {
    const parentId = events[activeId].parentId;
    for (const [eid, e] of Object.entries(events)) {
      if (e.parentId === parentId) {
        fetch(`/delete_event/${eid}`, { method: "POST" });
        delete events[eid];
      }
    }
  }
  closeDeleteModal();
  renderCalendar();
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
}

renderCalendar();
</script>
</body>
</html>

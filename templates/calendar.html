<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-wrapper {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .calendar-slide {
            flex: 0 0 100%;
            scroll-snap-align: start;
        }
        .event {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="{% if settings.theme == 'dark' %}bg-gray-900 text-white{% else %}bg-white text-black{% endif %} min-h-screen">

<header class="{% if settings.theme == 'dark' %}bg-gray-800{% else %}bg-gray-200{% endif %} p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Calendar</h1>
    <a href="/chat" class="text-blue-500 hover:underline">‚Üê Back to Chat</a>
</header>

<div class="p-4">
    <div class="flex justify-between items-center mb-4">
        <button onclick="prevMonth()" class="{% if settings.theme == 'dark' %}bg-gray-700{% else %}bg-gray-300{% endif %} px-4 py-2 rounded">Previous</button>
        <h2 id="monthYear" class="text-xl font-semibold"></h2>
        <button onclick="nextMonth()" class="{% if settings.theme == 'dark' %}bg-gray-700{% else %}bg-gray-300{% endif %} px-4 py-2 rounded">Next</button>
    </div>

    <div class="calendar-wrapper" id="calendarWrapper"></div>

    <h3 class="text-lg mt-6 mb-2">Add Event</h3>
    <div class="space-y-2">
        <input type="text" id="eventTitle" placeholder="Title" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-gray-100 text-black{% endif %}">
        <input type="text" id="eventDescription" placeholder="Description" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-gray-100 text-black{% endif %}">
        <input type="time" id="eventTime" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-gray-100 text-black{% endif %}">
        <select id="eventRepeat" class="w-full p-2 rounded border {% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-gray-100 text-black{% endif %}">
            <option value="none">No Repeat</option>
            <option value="daily">Every Day</option>
            <option value="weekly">Every Week</option>
            <option value="monthly">Every Month</option>
        </select>
        <button onclick="addEvent()" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-500">Add Event</button>
    </div>
</div>

<script>
const events = {{ events|tojson }};
const uid = "{{ uid }}";
let currentDate = new Date();

function renderCalendar() {
    const calendarWrapper = document.getElementById('calendarWrapper');
    calendarWrapper.innerHTML = '';

    for (let i = -1; i <= 1; i++) {
        const viewDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
        const slide = document.createElement('div');
        slide.className = 'calendar-slide px-2';

        const title = document.createElement('h3');
        title.className = "text-lg font-semibold mb-2";
        title.textContent = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        slide.appendChild(title);

        const grid = document.createElement('div');
        grid.className = "grid grid-cols-7 gap-2";

        const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
        const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();

        for (let d = 0; d < startDay; d++) {
            grid.appendChild(document.createElement('div'));
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const cell = document.createElement('div');
            cell.className = "{% if settings.theme == 'dark' %}bg-gray-700 text-white{% else %}bg-gray-100 text-black{% endif %} p-2 rounded cursor-pointer";
            cell.textContent = day;

            cell.onclick = () => showEvents(dateStr);
            grid.appendChild(cell);
        }

        slide.appendChild(grid);
        calendarWrapper.appendChild(slide);
    }

    document.getElementById('monthYear').textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
}

function prevMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}

function showEvents(date) {
    const dayEvents = Object.values(events).filter(e => e.date === date);
    const list = dayEvents.map(e => `
        <div class="event {% if settings.theme == 'dark' %}bg-gray-700 text-white{% else %}bg-gray-200 text-black{% endif %}">
            <strong>${e.title}</strong><br>${e.description}<br>${e.time || ''}<br>
            <button onclick="deleteEvent('${e.id}')"
                class="text-red-500">Delete</button>
        </div>
    `).join('');

    const modal = document.createElement('div');
    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center";
    modal.innerHTML = `<div class="{% if settings.theme == 'dark' %}bg-gray-800 text-white{% else %}bg-white text-black{% endif %} p-4 rounded max-w-sm w-full">
        <h3 class="text-lg mb-2">Events on ${date}</h3>
        ${list || 'No events'}
        <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-blue-600 text-white p-2 rounded">Close</button>
    </div>`;
    document.body.appendChild(modal);
}

function addEvent() {
    const title = document.getElementById('eventTitle').value;
    const description = document.getElementById('eventDescription').value;
    const time = document.getElementById('eventTime').value;
    const repeat = document.getElementById('eventRepeat').value;

    if (!title) return alert("Title is required");

    const date = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(currentDate.getDate()).padStart(2,'0')}`;
    const id = crypto.randomUUID();
    const parentId = repeat === "none" ? id : crypto.randomUUID();

    const newEvent = { title, description, date, time, repeat, parentId, id };
    events[id] = newEvent;

    fetch(`/save_event/${id}`, {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(newEvent)
    });

    renderCalendar();
}

function deleteEvent(id) {
    const event = events[id];
    if (!event) return;

    if (confirm("Delete all repeating events?")) {
        for (const [eid, e] of Object.entries(events)) {
            if (e.parentId === event.parentId) {
                fetch(`/delete_event/${eid}`, { method: "POST" });
                delete events[eid];
            }
        }
    } else {
        fetch(`/delete_event/${id}`, { method: "POST" });
        delete events[id];
    }

    renderCalendar();
}

renderCalendar();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<style>
  body { overflow-x: hidden; }
  .calendar-container { position: relative; overflow: hidden; }
  .calendar-slider { display: flex; transition: transform 0.3s ease; }
  .calendar-month { min-width: 100%; padding: 10px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .calendar-cell { min-height: 80px; border-radius: 8px; background-color: #374151; color: white; padding: 6px; cursor: pointer; }
  .today { border: 2px solid #60a5fa; background-color: #4b5563; }
  .event-badge { background: #60a5fa; color: white; padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; margin-top: 4px; display: block; }
</style>
</head>
<body class="bg-gray-900 text-white min-h-screen select-none">

<!-- Navbar -->
<header class="fixed top-0 w-full flex items-center justify-between p-4 bg-white dark:bg-gray-800 shadow z-50">
  <button onclick="toggleSidebar()" class="text-2xl text-gray-800 dark:text-white">â˜°</button>
  <h1 class="text-xl font-bold text-gray-900 dark:text-white">My Calendar</h1>
  <div>
    {% if session.get("user_picture") %}
      <button onclick="toggleMenu()" class="focus:outline-none"><img src="{{ session['user_picture'] }}" class="w-10 h-10 rounded-full"></button>
    {% else %}
      <button onclick="toggleMenu()" class="focus:outline-none"><img src="{{ url_for('static', filename='google_icon.png') }}" class="w-10 h-10 rounded-full"></button>
    {% endif %}
    <div id="userMenu" class="hidden absolute right-4 mt-2 bg-white dark:bg-gray-700 rounded shadow-lg w-40">
      {% if session.get("user_email") %}
        <a href="/settings" class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">Settings</a>
        <form method="POST" action="/logout" class="px-4 py-2"><button class="w-full text-left text-red-500 hover:underline">Logout</button></form>
      {% else %}
        <a href="/login" class="block px-4 py-2 text-center text-blue-500 hover:underline">Sign in with Google</a>
      {% endif %}
    </div>
  </div>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="fixed top-16 left-0 w-64 h-full bg-white dark:bg-gray-800 transform -translate-x-full transition-transform duration-300 z-40 p-4 shadow">
  <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">Dashboard</h2>
  <nav class="flex flex-col gap-2">
    <a href="/start_new_chat" class="text-blue-600 dark:text-blue-400 hover:underline">âž• Start New Chat</a>
    <a href="/calendar" class="text-blue-600 dark:text-blue-400 hover:underline">ðŸ“… Calendar</a>
  </nav>
</aside>

<!-- Main Calendar -->
<main class="mt-20 p-4">
<div class="flex justify-center items-center mb-4">
  <button onclick="goToPrev()" class="px-2 py-1 bg-gray-700 rounded">&lt;</button>
  <h2 id="monthTitle" class="mx-4 text-lg font-semibold cursor-pointer"></h2>
  <button onclick="goToNext()" class="px-2 py-1 bg-gray-700 rounded">&gt;</button>
</div>

<div class="calendar-grid font-semibold text-sm text-gray-400 mb-1 text-center">
  <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
</div>

<div class="calendar-container mb-6">
  <div id="slider" class="calendar-slider">
    <div class="calendar-month" id="prev"></div>
    <div class="calendar-month" id="current"></div>
    <div class="calendar-month" id="next"></div>
  </div>
</div>

<h2 class="text-xl font-semibold mb-2">Your Events:</h2>
<div id="eventList" class="space-y-2"></div>
</main>

<!-- Event Modal + Delete Confirm (same as previous version you have already) -->
<!-- (Can be copied from previous code, unchanged) -->

<script>
// Firebase Setup
const firebaseConfig = { apiKey: "YOUR-API-KEY", authDomain: "YOUR-PROJECT.firebaseapp.com", databaseURL: "https://YOUR-PROJECT.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
const uid = urlParams.get('gmail') || localStorage.getItem('gmail');
let events = {};
let currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear();

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
function toggleMenu() { document.getElementById('userMenu').classList.toggle('hidden'); }

function loadEvents() {
  firebase.database().ref('calendarEvents/' + uid).on('value', (snapshot) => {
    events = snapshot.val() || {}; renderAll();
  });
}

function shouldShowEvent(dateStr, e) {
  if (!e.date) return false;
  if (e.date === dateStr) return true;
  const d = new Date(e.date), c = new Date(dateStr);
  if (e.repeat === "daily") return true;
  if (e.repeat === "weekly" && d.getDay() === c.getDay()) return true;
  if (e.repeat === "monthly" && d.getDate() === c.getDate()) return true;
  return false;
}

function renderAll() {
  document.getElementById('monthTitle').textContent = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
  renderCalendar(normalizeDate(currentYear, currentMonth-1), document.getElementById('prev'));
  renderCalendar(normalizeDate(currentYear, currentMonth), document.getElementById('current'));
  renderCalendar(normalizeDate(currentYear, currentMonth+1), document.getElementById('next'));
  document.getElementById('slider').style.transform = `translateX(-100%)`;
  renderEventList();
}

function normalizeDate(y, m) { const d = new Date(y, m, 1); return { year: d.getFullYear(), month: d.getMonth() }; }

function renderCalendar({year, month}, el) {
  let html = "", fd = new Date(year, month, 1).getDay(), dim = new Date(year, month+1, 0).getDate();
  for (let i=0;i<fd;i++) html += `<div></div>`;
  for (let d=1;d<=dim;d++) {
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    html += `<div class="calendar-cell" onclick="openModal('${ds}')"><div>${d}</div>${renderEvents(ds)}</div>`;
  }
  el.innerHTML = `<div class="calendar-grid">${html}</div>`;
}

function renderEvents(ds) {
  return Object.entries(events).filter(([id,e]) => shouldShowEvent(ds,e))
    .map(([id,e]) => `<span class="event-badge" onclick="event.stopPropagation(); openModal('${ds}','${id}','${e.title}','${e.time}',${e.allDay},'${e.repeat}','${e.parentId}','${e.description}')">${e.title}</span>`).join('');
}

function renderEventList() {
  const list = document.getElementById('eventList');
  const monthStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
  list.innerHTML = Object.entries(events).filter(([id,e]) => Object.keys([...Array(31)]).some(d => shouldShowEvent(`${monthStr}-${String(+d+1).padStart(2,'0')}`, e)))
    .map(([id,e]) => `<div class="p-2 bg-gray-800 rounded">${e.title} - ${e.date} ${e.allDay?"(All Day)":e.time} - ${e.description}</div>`).join('')
    || '<p class="text-gray-400">No events this month.</p>';
}

function goToPrev() { currentMonth--; if (currentMonth<0) {currentMonth=11;currentYear--;} renderAll();}
function goToNext() { currentMonth++; if (currentMonth>11) {currentMonth=0;currentYear++;} renderAll();}

document.addEventListener('touchstart', e => startX=e.touches[0].clientX);
document.addEventListener('touchmove', e => document.getElementById('slider').style.transform = `translateX(${e.touches[0].clientX-startX-window.innerWidth}px)`);
document.addEventListener('touchend', e => {
  let diff = e.changedTouches[0].clientX-startX;
  if (diff > 50) { document.getElementById('slider').style.transform = `translateX(0)`; setTimeout(goToPrev, 300);}
  else if (diff < -50) { document.getElementById('slider').style.transform = `translateX(-200%)`; setTimeout(goToNext, 300);}
  else document.getElementById('slider').style.transform = `translateX(-100%)`;
});

window.onload = loadEvents;
</script>

</body>
</html>

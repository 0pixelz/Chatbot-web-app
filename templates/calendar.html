<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-cell {
      min-height: 80px;
      border-radius: 8px;
      background-color: var(--cell-bg);
      color: var(--cell-color);
      padding: 6px;
      position: relative;
      overflow-y: auto;
    }
    .calendar-cell.today {
      background-color: var(--cell-today-bg);
      border: 2px solid #60a5fa;
    }
    .event-badge {
      background: #60a5fa;
      color: white;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75rem;
      margin-top: 4px;
      display: block;
      text-align: center;
      cursor: pointer;
    }
    .calendar-container {
      position: relative;
      overflow: hidden;
    }
    .calendar-wrapper {
      display: flex;
      transition: transform 0.3s ease;
      will-change: transform;
    }
    .calendar-slide {
      min-width: 100%;
      box-sizing: border-box;
    }
    body.dark {
      --cell-bg: #374151;
      --cell-color: white;
      --cell-today-bg: #4b5563;
      --bg-color: #111827;
      --text-color: white;
      --input-bg: #374151;
      --input-color: white;
      --modal-bg: #1f2937;
    }
    body.light {
      --cell-bg: #f3f4f6;
      --cell-color: black;
      --cell-today-bg: #d1d5db;
      --bg-color: #ffffff;
      --text-color: black;
      --input-bg: #f3f4f6;
      --input-color: black;
      --modal-bg: #ffffff;
    }
  </style>
</head>
<body class="{% if settings.theme == 'dark' %}dark{% else %}light{% endif %} min-h-screen p-4" style="background-color: var(--bg-color); color: var(--text-color);">

<div class="flex justify-between items-center mb-4">
  <h1 class="text-2xl font-bold">My Calendar</h1>
</div>

<div class="flex justify-center items-center space-x-4 mb-2">
  <button onclick="prevMonth()" class="px-2 py-1 bg-gray-500 rounded hover:bg-gray-400 text-white">←</button>
  <h2 id="monthTitle" onclick="openDatePicker()" class="text-lg font-semibold cursor-pointer select-none"></h2>
  <button onclick="nextMonth()" class="px-2 py-1 bg-gray-500 rounded hover:bg-gray-400 text-white">→</button>
</div>

<div class="calendar-grid text-center font-semibold text-sm text-gray-400 mb-1">
  <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
</div>

<div class="calendar-container mb-4">
  <div class="calendar-wrapper" id="calendarWrapper">
    <div class="calendar-grid text-center calendar-slide" id="calendarPrev"></div>
    <div class="calendar-grid text-center calendar-slide" id="calendarCurrent"></div>
    <div class="calendar-grid text-center calendar-slide" id="calendarNext"></div>
  </div>
</div>

<hr class="border-gray-700 my-4">

<div id="eventsSection" class="space-y-2">
  <h2 class="text-xl font-semibold mb-2">Your Events:</h2>
  <div id="eventList" class="space-y-2"></div>
</div>

<div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="p-6 rounded-lg w-80" style="background-color: var(--modal-bg); color: var(--text-color);">
    <h3 id="modalTitle" class="text-lg font-bold mb-4">New Event</h3>
    <input type="hidden" id="modalDate">
    <input id="eventName" type="text" placeholder="Event Title" class="w-full mb-2 p-2 rounded" style="background-color: var(--input-bg); color: var(--input-color);">
    <textarea id="eventDescription" placeholder="Description" class="w-full mb-2 p-2 rounded" style="background-color: var(--input-bg); color: var(--input-color);"></textarea>
    <label class="flex items-center mb-2"><input type="checkbox" id="allDay" class="mr-2"> All Day</label>
    <input id="eventTime" type="time" class="w-full mb-2 p-2 rounded" style="background-color: var(--input-bg); color: var(--input-color);">
    <select id="repeat" class="w-full mb-4 p-2 rounded" style="background-color: var(--input-bg); color: var(--input-color);">
      <option value="none">Does not repeat</option>
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div class="flex space-x-2">
      <button onclick="saveModal()" class="flex-1 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white">Save</button>
      <button onclick="deleteModal()" id="deleteButton" class="flex-1 bg-red-500 hover:bg-red-600 px-4 py-2 rounded text-white hidden">Delete</button>
      <button onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded text-white">Cancel</button>
    </div>
  </div>
</div>

<div id="deleteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 hidden z-50">
  <div class="rounded-lg p-6 w-80 text-center" style="background-color: var(--modal-bg); color: var(--text-color);">
    <h2 class="text-lg font-bold mb-4">Delete Event</h2>
    <p class="mb-4">Delete this event or all events?</p>
    <div class="flex space-x-2 justify-center">
      <button onclick="confirmDelete('single')" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded text-white">Only This</button>
      <button onclick="confirmDelete('all')" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded text-white">All Events</button>
    </div>
    <button onclick="closeDeleteModal()" class="mt-4 text-sm text-gray-400 hover:underline">Cancel</button>
  </div>
</div>

<script>
const events = {{ events|tojson }};
const uid = "{{ uid }}";
let currentDate = new Date();
let activeDate = null;
let activeId = null;

function renderCalendar() {
  ['Prev','Current','Next'].forEach((view,i) => {
    const container = document.getElementById('calendar'+view);
    container.innerHTML = '';

    const viewDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + (i-1), 1);
    const start = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
    const days = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();

    for (let d=0; d<start; d++) container.appendChild(document.createElement('div'));

    for (let day=1; day<=days; day++) {
      const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = 'calendar-cell';
      if (dateStr === new Date().toISOString().split('T')[0]) cell.classList.add('today');
      cell.onclick = () => openModal(dateStr);

      const badge = Object.values(events).filter(e => e.date === dateStr);
      cell.innerHTML = `<div>${day}</div>` + badge.map(e => `<div class="event-badge" onclick="event.stopPropagation();openModal('${dateStr}','${e.id}')">${e.title}</div>`).join('');
      container.appendChild(cell);
    }
  });

  document.getElementById('monthTitle').textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
  document.getElementById('calendarWrapper').style.transform = "translateX(-100%)";

  renderEvents();
}

function prevMonth() { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
function nextMonth() { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }

function renderEvents() {
  const list = document.getElementById('eventList');
  list.innerHTML = Object.values(events).map(e => `<div class="p-2 rounded" style="background-color: var(--input-bg); color: var(--input-color);">${e.title} (${e.date})</div>`).join('');
}

function openModal(date,id=null) {
  activeDate = date;
  activeId = id;

  document.getElementById('modalDate').value = date;
  document.getElementById('eventName').value = id ? events[id].title : '';
  document.getElementById('eventDescription').value = id ? events[id].description : '';
  document.getElementById('eventTime').value = id ? events[id].time : '';
  document.getElementById('allDay').checked = id ? !events[id].time : false;
  document.getElementById('repeat').value = id ? events[id].repeat : 'none';
  document.getElementById('deleteButton').classList.toggle('hidden',!id);

  document.getElementById('modal').classList.remove('hidden');
}

function closeModal() { document.getElementById('modal').classList.add('hidden'); }

function saveModal() {
  const id = activeId || crypto.randomUUID();
  const parentId = activeId ? events[activeId].parentId : crypto.randomUUID();
  const data = {
    title: document.getElementById('eventName').value,
    description: document.getElementById('eventDescription').value,
    date: activeDate,
    time: document.getElementById('allDay').checked ? '' : document.getElementById('eventTime').value,
    repeat: document.getElementById('repeat').value,
    parentId,
    id
  };

  events[id] = data;
  fetch(`/save_event/${id}`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  closeModal(); renderCalendar();
}

function deleteModal() {
  document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
}

function confirmDelete(type) {
  if (type === 'single') {
    fetch(`/delete_event/${activeId}`,{method:"POST"});
    delete events[activeId];
  } else {
    Object.entries(events).forEach(([id,e]) => {
      if (e.parentId === events[activeId].parentId) {
        fetch(`/delete_event/${id}`,{method:"POST"});
        delete events[id];
      }
    });
  }
  closeDeleteModal(); closeModal(); renderCalendar();
}

renderCalendar();
</script>
</body>
</html>

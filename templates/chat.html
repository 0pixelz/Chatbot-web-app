<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Calendar</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  .calendar-container { position: relative; overflow: hidden; }
  .calendar-slider { display: flex; transition: transform 0.3s ease; }
  .calendar-month { min-width: 100%; padding: 10px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .calendar-cell { min-height: 80px; border-radius: 8px; background-color: #374151; color: white; padding: 6px; overflow-y: auto; cursor: pointer; }
  .today { border: 2px solid #60a5fa; background-color: #4b5563; }
  .event-badge { background-color: #3b82f6; color: white; padding: 4px 6px; border-radius: 6px; font-size: 0.75rem; margin-top: 4px; display: inline-block; }
</style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 select-none">

<h1 class="text-2xl font-bold mb-4">My Calendar</h1>

<div class="flex justify-center items-center mb-4">
  <button onclick="goToPrev()" class="px-2 py-1 bg-gray-700 rounded">&lt;</button>
  <h2 id="monthTitle" class="mx-4 text-lg font-semibold cursor-pointer"></h2>
  <button onclick="goToNext()" class="px-2 py-1 bg-gray-700 rounded">&gt;</button>
</div>

<div class="calendar-grid font-semibold text-sm text-gray-400 mb-1 text-center">
  <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
</div>

<div class="calendar-container">
  <div id="slider" class="calendar-slider">
    <div class="calendar-month" id="prev"></div>
    <div class="calendar-month" id="current"></div>
    <div class="calendar-month" id="next"></div>
  </div>
</div>

<hr class="border-gray-700 my-6">

<h2 class="text-xl font-semibold mb-2">Your Events:</h2>
<div id="eventList" class="space-y-2"></div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 p-6 rounded-lg w-80">
    <h3 class="text-lg font-bold mb-4">Event Details</h3>
    <input type="hidden" id="modalDate">
    <input id="eventName" type="text" placeholder="Event Title" class="w-full mb-2 p-2 rounded bg-gray-700 text-white">
    <textarea id="eventDescription" placeholder="Description" class="w-full mb-2 p-2 rounded bg-gray-700 text-white"></textarea>
    <input id="eventTime" type="time" class="w-full mb-2 p-2 rounded bg-gray-700 text-white">
    <label class="flex items-center mb-2"><input type="checkbox" id="allDay" class="mr-2"> All Day</label>
    <select id="repeat" class="w-full mb-4 p-2 rounded bg-gray-700 text-white">
      <option value="none">No Repeat</option>
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div class="flex space-x-2">
      <button onclick="saveModal()" class="flex-1 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Save</button>
      <button onclick="deleteModal()" id="deleteButton" class="hidden flex-1 bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Delete</button>
      <button onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancel</button>
    </div>
  </div>
</div>

<script>
// Firebase initialization
const firebaseConfig = {
  apiKey: "YOUR-API-KEY",
  authDomain: "YOUR-PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR-PROJECT.firebaseio.com",
  projectId: "YOUR-PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const uid = "{{ uid }}";

let events = {};
function loadEvents() {
  firebase.database().ref('events/' + uid).on('value', (snapshot) => {
    events = snapshot.val() || {};
    renderAll();
  });
}

// Calendar functions (render, navigation, swipe)
function shouldShowEvent(dateStr, e) {
  const eventDate = new Date(e.date);
  const checkDate = new Date(dateStr);
  return eventDate.toDateString() === checkDate.toDateString() ||
    (e.repeat === "daily") ||
    (e.repeat === "weekly" && eventDate.getDay() === checkDate.getDay()) ||
    (e.repeat === "monthly" && eventDate.getDate() === checkDate.getDate());
}

let currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear();

function renderAll() {
  document.getElementById('monthTitle').textContent = new Date(currentYear, currentMonth).toLocaleDateString('default', {month:'long',year:'numeric'});
  ["prev","current","next"].forEach((id,i)=>renderCalendar(currentYear,currentMonth-1+i,document.getElementById(id)));
  document.getElementById('slider').style.transform = 'translateX(-100%)';
  renderEventList();
}

function renderCalendar(y,m,c) {
  let d=new Date(y,m,1),html='',f=d.getDay(),days=new Date(y,m+1,0).getDate();
  html+="<div class='calendar-grid'>"+'<div></div>'.repeat(f);
  for(let i=1;i<=days;i++){
    let dt=`${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
    let t=dt===new Date().toISOString().split('T')[0];
    html+=`<div onclick="openModal('${dt}')" class='calendar-cell ${t?'today':''}'>${i}${renderEvents(dt)}</div>`;
  }
  c.innerHTML=html+'</div>';
}

function renderEvents(d){return Object.values(events).filter(e=>shouldShowEvent(d,e)).map(e=>`<span class="event-badge">${e.title}</span>`).join('');}

function renderEventList(){
  let html=Object.values(events).map(e=>`<div class="p-2 bg-gray-800 rounded">${e.title}<br>${e.date}${e.allDay?"(All Day)":" "+e.time}<br>${e.description||''}</div>`).join('');
  document.getElementById('eventList').innerHTML=html||"<p>No events this month.</p>";
}

// Modal functions
window.openModal=(d)=>{modalDate.value=d;modal.style.display="flex";}
window.closeModal=()=>modal.style.display="none";
window.saveModal=()=>{
  let id=db.ref().push().key;events[id]={date:modalDate.value,title:eventName.value,time:eventTime.value,allDay:allDay.checked,description:eventDescription.value,repeat:repeat.value};
  db.ref('events/'+uid+'/'+id).set(events[id]);closeModal();}
window.deleteModal=()=>{db.ref('events/'+uid+'/'+deleteTargetId).remove();closeModal();}

// Swipe & init
window.onload=()=>loadEvents();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personal AI Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { overflow-x: hidden; }
    .chat-bubble {
      max-width: 85%;
      padding: 10px 15px;
      border-radius: 1rem;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    .chat-bubble-user { background-color: #3b82f6; color: white; align-self: flex-end; }
    .chat-bubble-assistant { background-color: #e5e7eb; color: black; align-self: flex-start; }
    .dark .chat-bubble-user { background-color: #2563eb; }
    .dark .chat-bubble-assistant { background-color: #4b5563; color: white; }
  </style>
</head>

<body class="flex flex-col min-h-screen {% if settings.theme == 'dark' %}dark bg-gray-900{% else %}bg-white{% endif %}">

<!-- Navbar -->
<header class="fixed top-0 w-full flex items-center justify-between p-4 bg-white dark:bg-gray-800 shadow z-50">
  <button onclick="toggleSidebar()" class="text-2xl text-gray-800 dark:text-white">‚ò∞</button>
  <h1 class="text-xl font-bold text-gray-900 dark:text-white">Personal AI Bot</h1>
  <div>
    {% if session.get("user_picture") %}
      <button onclick="toggleMenu()" class="focus:outline-none"><img src="{{ session['user_picture'] }}" class="w-10 h-10 rounded-full"></button>
    {% else %}
      <button onclick="toggleMenu()" class="focus:outline-none"><img src="{{ url_for('static', filename='google_icon.png') }}" class="w-10 h-10 rounded-full"></button>
    {% endif %}
    <div id="userMenu" class="hidden absolute right-4 mt-2 bg-white dark:bg-gray-700 rounded shadow-lg w-40">
      {% if session.get("user_email") %}
        <a href="/settings" class="block px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">Settings</a>
        <form method="POST" action="/logout" class="px-4 py-2"><button class="w-full text-left text-red-500 hover:underline">Logout</button></form>
      {% else %}
        <a href="/login" class="block px-4 py-2 text-center text-blue-500 hover:underline">Sign in with Google</a>
      {% endif %}
    </div>
  </div>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="fixed top-16 left-0 w-64 h-full bg-white dark:bg-gray-800 transform -translate-x-full transition-transform duration-300 z-40 p-4 shadow">
  <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">Dashboard</h2>
  <nav class="flex flex-col gap-2">
    {% if session.get("user_email") %}
      <a href="/start_new_chat" class="text-blue-600 dark:text-blue-400 hover:underline">‚ûï Start New Chat</a>
      <a href="/calendar" class="text-blue-600 dark:text-blue-400 hover:underline">üìÖ Calendar</a>
      <a href="/settings" class="text-blue-600 dark:text-blue-400 hover:underline">‚öôÔ∏è Settings</a>
    {% else %}
      <div class="text-gray-400">Sign in to access options</div>
    {% endif %}
    {% if conversations %}
      {% for convo_id, convo_data in conversations.items() %}
        <div class="flex justify-between items-center group">
          <a href="/chat/{{ convo_id }}" class="truncate w-40 text-gray-700 dark:text-gray-300 hover:underline">
            {{ convo_data.title if convo_data.title else 'New Chat' }}
          </a>
          <form method="POST" action="/delete_conversation/{{ convo_id }}" onsubmit="return confirm('Delete this conversation?')">
            <button class="text-red-500 opacity-0 group-hover:opacity-100">üóëÔ∏è</button>
          </form>
        </div>
      {% endfor %}
    {% endif %}
  </nav>
</aside>

<!-- Chat Area -->
<main id="chatArea" class="flex-1 overflow-y-auto p-4 mt-20 mb-28 flex flex-col gap-4">
  {% for msg in history %}
    <div class="chat-bubble {% if msg.role == 'user' %}chat-bubble-user{% else %}chat-bubble-assistant{% endif %}">
      {{ msg.content }}
    </div>
  {% endfor %}
</main>

<!-- Input -->
<form id="chatForm" method="POST" action="/chat/{{ convo_id }}" class="fixed bottom-0 left-0 w-full bg-white dark:bg-gray-900 p-4 flex justify-center">
  <div class="flex w-full max-w-3xl items-center bg-white dark:bg-gray-800 rounded-2xl shadow px-3 py-2">
    <textarea id="messageInput" name="message" rows="1" placeholder="Type your message..." class="flex-1 resize-none bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none p-2" required style="max-height: 300px; overflow-y: auto;"></textarea>
    <button id="sendButton" type="submit" class="p-3 bg-gray-700 hover:bg-gray-600 text-white rounded-full ml-2" disabled>‚ûî</button>
    <button id="stopButton" type="button" onclick="stopTyping()" class="hidden p-3 bg-gray-700 hover:bg-gray-600 text-white rounded-full ml-2">‚èπÔ∏è</button>
  </div>
</form>

<script>
let typingInterval = null;
let isTyping = false;

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('-translate-x-full');
}

function toggleMenu() {
  document.getElementById('userMenu').classList.toggle('hidden');
}

function scrollToBottom() {
  const chatArea = document.getElementById('chatArea');
  chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
}

function animateMessages() {
  const chatArea = document.getElementById('chatArea');
  const bubbles = chatArea.querySelectorAll('.chat-bubble-assistant');
  if (!bubbles.length) return;
  const lastBubble = bubbles[bubbles.length - 1];
  const fullText = lastBubble.textContent.trim();
  lastBubble.textContent = '';
  isTyping = true;
  let i = 0;

  function typeChar() {
    if (!isTyping) return;
    if (i < fullText.length) {
      lastBubble.textContent += fullText.charAt(i);
      i++;
      scrollToBottom();
      typingInterval = setTimeout(typeChar, 15);
    } else {
      finishTyping();
    }
  }
  typeChar();
}

function finishTyping() {
  document.getElementById('messageInput').disabled = false;
  document.getElementById('sendButton').disabled = false;
  document.getElementById('stopButton').classList.add('hidden');
  isTyping = false;
  clearTimeout(typingInterval);
}

function stopTyping() {
  isTyping = false;
  finishTyping();
}

const textarea = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const chatForm = document.getElementById('chatForm');

textarea.addEventListener('input', () => {
  textarea.style.height = 'auto';
  textarea.style.height = (textarea.scrollHeight) + 'px';
  sendButton.disabled = textarea.value.trim().length === 0;
});

chatForm.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    if (!sendButton.disabled && !textarea.disabled) {
      chatForm.submit();
      textarea.value = '';
      sendButton.disabled = true;
    }
  }
});

textarea.addEventListener('focus', () => {
  document.getElementById('sidebar').classList.add('-translate-x-full');
  setTimeout(() => { scrollToBottom(); }, 300);
});

window.onload = function() {
  scrollToBottom();
  animateMessages();
};
</script>

</body>
</html>

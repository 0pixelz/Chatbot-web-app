<script>
let typingInterval = null;
let isTyping = false;

// === Sidebar toggle ===
function toggleSidebar() { ... }
function closeSidebar() { ... }
function toggleMenu() { ... }
function scrollToBottom() { ... }

// === Popup notification after send ===
function showPopup() {
  const popup = document.getElementById('popupNotification');
  popup.classList.remove('hidden');
  setTimeout(() => {
    popup.classList.add('hidden');
  }, 2000);
}

// === Typing effect and Disable Textarea ===
function animateMessages() {
  const chatArea = document.getElementById('chatArea');
  const messages = chatArea.querySelectorAll('[data-role]');
  const typingIndicator = document.getElementById('typingIndicator');
  const textarea = document.getElementById('messageInput');
  const stopButton = document.getElementById('stopButton');

  messages.forEach((div, index) => {
    const fullText = div.textContent;
    const role = div.getAttribute('data-role');
    div.textContent = '';

    if (role === 'assistant') {
      typingIndicator.classList.remove('hidden');
      textarea.disabled = true;
      stopButton.classList.remove('hidden');
      isTyping = true;

      let i = 0;
      function typeChar() {
        if (!isTyping) return;
        if (i < fullText.length) {
          div.textContent += fullText.charAt(i);
          i++;
          scrollToBottom();
          typingInterval = setTimeout(typeChar, 15);
        } else {
          finishTyping();
        }
      }
      typeChar();
    } else {
      div.textContent = fullText;
    }
  });

  // === Add Edit Button to Last User Message ===
  const lastUser = [...messages].reverse().find(div => div.getAttribute('data-role') === 'user');
  if (lastUser) {
    const editBtn = document.createElement('button');
    editBtn.innerText = '✏️ Edit';
    editBtn.className = 'ml-2 text-sm text-blue-600 hover:underline';
    editBtn.onclick = () => {
      textarea.value = lastUser.innerText.trim();
      textarea.focus();
    };
    lastUser.parentElement.appendChild(editBtn);
  }
}

function finishTyping() {
  const typingIndicator = document.getElementById('typingIndicator');
  const textarea = document.getElementById('messageInput');
  const stopButton = document.getElementById('stopButton');

  typingIndicator.classList.add('hidden');
  textarea.disabled = false;
  stopButton.classList.add('hidden');
  isTyping = false;
  clearTimeout(typingInterval);
}

// === Stop Generating Button Function ===
function stopTyping() {
  isTyping = false;
  finishTyping();
}

// === Auto-grow textarea and Shift+Enter ===
const textarea = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const chatForm = document.getElementById('chatForm');

textarea.addEventListener('input', () => {
  textarea.style.height = 'auto';
  textarea.style.height = (textarea.scrollHeight) + 'px';

  if (textarea.value.trim().length > 0) {
    sendButton.disabled = false;
  } else {
    sendButton.disabled = true;
  }
});

chatForm.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    if (!sendButton.disabled && !textarea.disabled) {
      chatForm.submit();
      textarea.value = '';
      sendButton.disabled = true;
    }
  }
});

window.onload = function() {
  animateMessages();
  scrollToBottom();
}
</script>

<!DOCTYPE html>
<html lang="en" {% if settings.theme == 'dark' %}class="dark"{% endif %}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot</title>
  <!-- Tailwind with dark-mode class strategy -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex h-screen overflow-hidden">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="hidden md:flex flex-col w-64 bg-gray-100 dark:bg-gray-800 p-4">
    <h2 class="text-xl font-bold mb-4">Conversations</h2>
    <button id="new-chat" class="mb-4 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
      + New Conversation
    </button>
    <nav class="flex-1 overflow-auto">
      <ul>
        {% for cid, convo in chats.items() %}
          <li class="mb-2">
            <a href="{{ url_for('chat', convo_id=cid) }}"
               class="block px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 {% if convo.id == request.args.get('convo_id') %}bg-gray-300 dark:bg-gray-700{% endif %}">
              {{ convo.title or 'Untitled' }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </nav>
  </aside>

  <!-- MAIN PANEL -->
  <div class="flex-1 flex flex-col">

    <!-- HEADER -->
    <header class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 shadow">
      <!-- hamburger -->
      <button id="toggle-sidebar" class="md:hidden p-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <h1 class="text-2xl font-semibold">Chatbot</h1>

      <!-- avatar & dropdown -->
      <div class="relative">
        <img id="user-menu-btn"
             src="{{ session.get('user_picture','https://via.placeholder.com/40') }}"
             alt="Avatar"
             class="w-8 h-8 rounded-full cursor-pointer border-2 border-gray-300 dark:border-gray-600">
        <div id="user-menu"
             class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 rounded shadow-lg overflow-hidden z-10">
          <a href="{{ url_for('settings') }}"
             class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">Settings</a>
          <form action="{{ url_for('logout') }}" method="post">
            <button type="submit"
                    class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">
              Logout
            </button>
          </form>
        </div>
      </div>
    </header>

    <!-- CHAT AREA -->
    <main class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900">
      {% for msg in history %}
        <div class="space-y-1">
          <div class="flex items-center space-x-2">
            <span class="font-semibold {% if msg.role=='user' %}text-blue-500{% else %}text-green-500{% endif %}">
              {{ msg.role|capitalize }}
            </span>
            <span class="text-xs text-gray-500">{{ msg.time }}</span>
          </div>
          <div class="px-4 py-2 rounded-lg
                      {% if msg.role=='user' %}
                        bg-blue-100 dark:bg-blue-900
                      {% else %}
                        bg-gray-200 dark:bg-gray-800
                      {% endif %}">
            {{ msg.content }}
          </div>
        </div>
      {% endfor %}
    </main>

    <!-- INPUT BOX -->
    <form action="{{ url_for('chat') }}{% if request.args.get('convo_id') %}?convo_id={{ request.args.get('convo_id') }}{% endif %}"
          method="post"
          class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
      <textarea name="message"
                rows="2"
                required
                class="w-full p-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none">
      </textarea>
      <button type="submit"
              class="mt-2 px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded hover:bg-blue-600">
        Send
      </button>
    </form>

  </div>

  <!-- SCRIPTS -->
  <script>
    // Sidebar toggle
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('hidden');
    });
    // Avatar menu
    document.getElementById('user-menu-btn').addEventListener('click', () => {
      document.getElementById('user-menu').classList.toggle('hidden');
    });
    // New Conversation (POST to your new route)
    document.getElementById('new-chat').addEventListener('click', () => {
      fetch("{{ url_for('new_conversation') }}", { method: "POST" })
        .then(() => window.location.reload());
    });
  </script>

</body>
</html>
